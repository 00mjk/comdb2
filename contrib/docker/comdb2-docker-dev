#!/bin/bash

set -e

if [[ $# -lt 1 ]]; then
    echo >&2 "Usage: $* dbname [dbname2 ...]"
    exit 1
fi

firstdb=$1

container=$(docker run -d --expose=5105 comdb2-dev $*)
if [[ -z "$container" ]]; then
    exit 1
fi

addr=$(docker inspect $container | jq -r ".[0].NetworkSettings.IPAddress")
LOG=${TMPDIR:-/tmp}/comdb2-dev-$$.cfg
(
echo comdb2_config:allow_pmux_route:true
for db in $*; do
    echo "$db:$addr"
done 
echo comdb2_config:default_type:docker
) > $LOG

echo "Container is up. Run"
echo
echo "export CDB2_CONFIG_FILE=$LOG"
echo
echo "Databases can then be accessed, eg:"
echo "cdb2sql $firstdb default 'select 1'"
